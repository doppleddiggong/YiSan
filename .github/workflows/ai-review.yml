# ì›Œí¬í”Œë¡œìš° ì´ë¦„ ì„¤ì •
name: AI Code Review

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´ ì„¤ì •
on:
  # pull_request ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  # types: [opened, synchronize]ëŠ” PRì´ ì—´ë¦¬ê±°ë‚˜(opened) ìƒˆë¡œìš´ ì»¤ë°‹ìœ¼ë¡œ ë™ê¸°í™”ë  ë•Œ(synchronize) íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤.
  pull_request:
    paths:
      - 'Source/**' # Source ë””ë ‰í† ë¦¬ ë‚´ ëª¨ë“  íŒŒì¼ ë³€ê²½ ì‹œ íŠ¸ë¦¬ê±°

# ì‘ì—…(Jobs) ì •ì˜
jobs:
  review:
    # ì´ ì‘ì—…ì€ ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    runs-on: ubuntu-latest

    # ì‘ì—… ë‹¨ê³„(Steps) ì •ì˜
    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      # PRì˜ ìµœì‹  ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° ëŸ¬ë„ˆë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - uses: actions/checkout@v4

      # 2. ë³€ê²½ì‚¬í•­(Diff) ì¶”ì¶œ
      # í˜„ì¬ PRì˜ ë³€ê²½ì‚¬í•­ì„ diff í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•˜ì—¬ changes.patch íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
      # git fetch origin ${{ github.base_ref }} : ë² ì´ìŠ¤ ë¸Œëœì¹˜ì˜ ìµœì‹  ìƒíƒœë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      # git diff origin/${{ github.base_ref }}...HEAD : ë² ì´ìŠ¤ ë¸Œëœì¹˜ì™€ í˜„ì¬ PR í—¤ë“œ ê°„ì˜ ì°¨ì´ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
      - name: Extract Diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > changes.patch

      # 3. GPTë¥¼ í˜¸ì¶œí•˜ì—¬ ì½”ë“œ ë¦¬ë·° ìˆ˜í–‰
      # OpenAI APIë¥¼ ì‚¬ìš©í•˜ì—¬ changes.patch íŒŒì¼ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì½”ë“œ ë¦¬ë·°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
      - name: Call GPT for Review
        id: ai_review # ì´ ìŠ¤í…ì˜ ì¶œë ¥ì„ ì°¸ì¡°í•˜ê¸° ìœ„í•œ ID
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }} # GitHub Secretsì— ì €ì¥ëœ OpenAI API í‚¤ ì‚¬ìš©
        run: |
          # curl ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ OpenAI Chat Completions API í˜¸ì¶œ
          REVIEW=$(curl https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4o\", # ì‚¬ìš©í•  OpenAI ëª¨ë¸ ì§€ì •
              \"messages\": [
                {\"role\": \"system\", \"content\": \"You are a strict and pragmatic senior C++/C# code reviewer. Focus on performance, memory safety, const correctness, Unreal Engine coding conventions, and any possible bugs. Be concise and direct.\"}, # AIì˜ ì—­í•  ë° ì§€ì‹œì‚¬í•­ ì„¤ì •
                {\"role\": \"user\", \"content\": \"Review this code diff and suggest improvements:\\n$(cat changes.patch)\"}
              ]
            }" | jq -r '.choices[0].message.content') # jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON ì‘ë‹µì—ì„œ ë¦¬ë·° ë‚´ìš© ì¶”ì¶œ

          echo "$REVIEW" > review.txt # ì¶”ì¶œëœ ë¦¬ë·° ë‚´ìš©ì„ review.txt íŒŒì¼ë¡œ ì €ì¥
          echo "review_body=$REVIEW" >> $GITHUB_OUTPUT # ë¦¬ë·° ë‚´ìš©ì„ ì›Œí¬í”Œë¡œìš° ì¶œë ¥ìœ¼ë¡œ ì„¤ì •

      # 4. PRì— ë¦¬ë·° ì½”ë©˜íŠ¸ ê²Œì‹œ
      # AIê°€ ìƒì„±í•œ ë¦¬ë·° ë‚´ìš©ì„ Pull Requestì— ì½”ë©˜íŠ¸ë¡œ ê²Œì‹œí•©ë‹ˆë‹¤.
      # marocchino/sticky-pull-request-comment@v2 ì•¡ì…˜ì€ ê¸°ì¡´ ì½”ë©˜íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¤‘ë³µì„ ë°©ì§€í•©ë‹ˆë‹¤.
      - name: Post Comment to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ğŸ¤– AI Code Review" # ì½”ë©˜íŠ¸ í—¤ë”
          message: ${{ steps.ai_review.outputs.review_body }} # ì´ì „ ìŠ¤í…ì—ì„œ ìƒì„±ëœ ë¦¬ë·° ë‚´ìš©ì„ ì½”ë©˜íŠ¸ ë©”ì‹œì§€ë¡œ ì‚¬ìš©

      # 5. Discordë¡œ ë¦¬ë·° ê²°ê³¼ ì „ì†¡
      # AI ì½”ë“œ ë¦¬ë·° ê²°ê³¼ë¥¼ Discord ì›¹í›…ì„ í†µí•´ íŠ¹ì • ì±„ë„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
      - name: Send Review to Discord
        if: always()  # ì´ì „ ìŠ¤í…ì˜ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }} # GitHub Secretsì— ì €ì¥ëœ Discord ì›¹í›… URL ì‚¬ìš©
        run: |
          # Markdown ë° ë”°ì˜´í‘œë¥¼ ì´ìŠ¤ì¼€ì´í”„í•˜ì—¬ JSON ìœ íš¨ì„± í™•ë³´
          ESCAPED_REVIEW=$(echo "${{ steps.ai_review.outputs.review_body }}" | jq -Rs .) # jqë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ë·° ë³¸ë¬¸ì„ JSON ë¬¸ìì—´ë¡œ ì´ìŠ¤ì¼€ì´í”„

          # curl ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ Discord ì›¹í›…ìœ¼ë¡œ ì„ë² ë“œ ë©”ì‹œì§€ ì „ì†¡
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"username\": \"AI Reviewer ğŸ¤–\", # Discordì— í‘œì‹œë  ë´‡ ì´ë¦„
              \"embeds\": [{
                \"title\": \"AI Code Review on PR #${{ github.event.pull_request.number }}\", # ì„ë² ë“œ ì œëª© (PR ë²ˆí˜¸ í¬í•¨)
                \"url\": \"${{ github.event.pull_request.html_url }}\", # PR ë§í¬
                \"description\": ${ESCAPED_REVIEW}, # AI ë¦¬ë·° ë‚´ìš© (ì´ìŠ¤ì¼€ì´í”„ëœ JSON ë¬¸ìì—´)
                \"color\": 5814783, # ì„ë² ë“œ ìƒ‰ìƒ (ì‹­ì§„ìˆ˜)
                \"fields\": [
                  {
                    \"name\": \"ğŸ”€ Branch\",
                    \"value\": \"${{ github.head_ref }} â†’ ${{ github.base_ref }}\", # ë¸Œëœì¹˜ ì •ë³´
                    \"inline\": true
                  },
                  {
                    \"name\": \"ğŸ§  Author\",
                    \"value\": \"${{ github.event.pull_request.user.login }}\", # PR ì‘ì„±ì
                    \"inline\": true
                  }
                ],
                \"footer\": {
                  \"text\": \"Generated by GPT-4 via GitHub Actions\"
                },
                \"timestamp\": \"$(date --iso-8601=seconds)\" # í˜„ì¬ ì‹œê°„ (ISO 8601 í˜•ì‹)
              }]
            }" \
            $DISCORD_WEBHOOK # Discord ì›¹í›… URL
    
