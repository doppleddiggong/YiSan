# ì›Œí¬í”Œë¡œìš° ì´ë¦„ ì„¤ì •
name: AI Code Review

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´ ì„¤ì •
on:
  push:
    paths:
      - 'Source/**' # Source ë””ë ‰í† ë¦¬ ë‚´ ëª¨ë“  íŒŒì¼ ë³€ê²½ ì‹œ íŠ¸ë¦¬ê±°


  # pull_request ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  # types: [opened, synchronize]ëŠ” PRì´ ì—´ë¦¬ê±°ë‚˜(opened) ìƒˆë¡œìš´ ì»¤ë°‹ìœ¼ë¡œ ë™ê¸°í™”ë  ë•Œ(synchronize) íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤.
  pull_request:
    paths:
      - 'Source/**' # Source ë””ë ‰í† ë¦¬ ë‚´ ëª¨ë“  íŒŒì¼ ë³€ê²½ ì‹œ íŠ¸ë¦¬ê±°

# ì‘ì—…(Jobs) ì •ì˜
jobs:
  review:
    # ì´ ì‘ì—…ì€ ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    runs-on: ubuntu-latest

    # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì— í•„ìš”í•œ ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.
    # contents: read - ì €ì¥ì†Œ ì½˜í…ì¸ ë¥¼ ì½ê³  ì²´í¬ì•„ì›ƒí•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
    # pull-requests: write - PRì— ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
    permissions:
      contents: read
      pull-requests: write

    # ì‘ì—… ë‹¨ê³„(Steps) ì •ì˜
    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      # PRì˜ ìµœì‹  ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° ëŸ¬ë„ˆë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
      # diff ìƒì„±ì„ ìœ„í•´ fetch-depth: 0ìœ¼ë¡œ ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ë³€ê²½ì‚¬í•­(Diff) ì¶”ì¶œ
      # ì´ë²¤íŠ¸(pull_request ë˜ëŠ” push)ì— ë”°ë¼ ì ì ˆí•œ diffë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
      - name: Extract Diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Pull Request: ë² ì´ìŠ¤ ë¸Œëœì¹˜ì™€ í˜„ì¬ PR í—¤ë“œ ê°„ì˜ ì°¨ì´ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
            git diff origin/${{ github.base_ref }}...HEAD > changes.patch
          else
            # Push: 'before'ì™€ 'after' ì»¤ë°‹ì„ ê¸°ë°˜ìœ¼ë¡œ diffë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
              # ìƒˆ ë¸Œëœì¹˜ ìƒì„±: ì²« ì»¤ë°‹ì˜ ëª¨ë“  íŒŒì¼ì„ diffë¡œ ìƒì„±í•©ë‹ˆë‹¤.
              git diff 4b825dc642cb6eb9a060e54bf8d69288fbee4904 ${{ github.sha }} > changes.patch
            else
              # ê¸°ì¡´ ë¸Œëœì¹˜ì— í‘¸ì‹œ: í‘¸ì‹œ ì „í›„ì˜ ë³€ê²½ì‚¬í•­ì„ diffí•©ë‹ˆë‹¤.
              git diff ${{ github.event.before }}..${{ github.sha }} > changes.patch
            fi
          fi

      # 3. GPTë¥¼ í˜¸ì¶œí•˜ì—¬ ì½”ë“œ ë¦¬ë·° ìˆ˜í–‰
      # OpenAI APIë¥¼ ì‚¬ìš©í•˜ì—¬ changes.patch íŒŒì¼ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì½”ë“œ ë¦¬ë·°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
      - name: Call GPT for Review
        id: ai_review # ì´ ìŠ¤í…ì˜ ì¶œë ¥ì„ ì°¸ì¡°í•˜ê¸° ìœ„í•œ ID
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }} # GitHub Secretsì— ì €ì¥ëœ OpenAI API í‚¤ ì‚¬ìš©
        run: |
          # curl ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ OpenAI Chat Completions API í˜¸ì¶œ
          REVIEW=$(curl https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4o\", # ì‚¬ìš©í•  OpenAI ëª¨ë¸ ì§€ì •
              \"messages\": [
                {\"role\": \"system\", \"content\": \"You are a strict and pragmatic senior C++/C# code reviewer. Focus on performance, memory safety, const correctness, Unreal Engine coding conventions, and any possible bugs. Be concise and direct.\"}, # AIì˜ ì—­í•  ë° ì§€ì‹œì‚¬í•­ ì„¤ì •
                {\"role\": \"user\", \"content\": \"Review this code diff and suggest improvements:\\n$(cat changes.patch)\"}
              ]
            }" | jq -r '.choices[0].message.content') # jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON ì‘ë‹µì—ì„œ ë¦¬ë·° ë‚´ìš© ì¶”ì¶œ

          echo "$REVIEW" > review.txt # ì¶”ì¶œëœ ë¦¬ë·° ë‚´ìš©ì„ review.txt íŒŒì¼ë¡œ ì €ì¥
          echo "review_body=$REVIEW" >> $GITHUB_OUTPUT # ë¦¬ë·° ë‚´ìš©ì„ ì›Œí¬í”Œë¡œìš° ì¶œë ¥ìœ¼ë¡œ ì„¤ì •

      # 4. PRì— ë¦¬ë·° ì½”ë©˜íŠ¸ ê²Œì‹œ
      # AIê°€ ìƒì„±í•œ ë¦¬ë·° ë‚´ìš©ì„ Pull Requestì— ì½”ë©˜íŠ¸ë¡œ ê²Œì‹œí•©ë‹ˆë‹¤.
      # marocchino/sticky-pull-request-comment@v2 ì•¡ì…˜ì€ ê¸°ì¡´ ì½”ë©˜íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¤‘ë³µì„ ë°©ì§€í•©ë‹ˆë‹¤.
      # ì´ ìŠ¤í…ì€ pull_request ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
      - name: Post Comment to PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ğŸ¤– AI Code Review" # ì½”ë©˜íŠ¸ í—¤ë”
          message: ${{ steps.ai_review.outputs.review_body }} # ì´ì „ ìŠ¤í…ì—ì„œ ìƒì„±ëœ ë¦¬ë·° ë‚´ìš©ì„ ì½”ë©˜íŠ¸ ë©”ì‹œì§€ë¡œ ì‚¬ìš©

      # 5. Discordë¡œ ë¦¬ë·° ê²°ê³¼ ì „ì†¡
      # AI ì½”ë“œ ë¦¬ë·° ê²°ê³¼ë¥¼ Discord ì›¹í›…ì„ í†µí•´ íŠ¹ì • ì±„ë„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
      - name: Send Review to Discord
        if: always()  # ì´ì „ ìŠ¤í…ì˜ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }} # GitHub Secretsì— ì €ì¥ëœ Discord ì›¹í›… URL ì‚¬ìš©
        run: |
          # Markdown ë° ë”°ì˜´í‘œë¥¼ ì´ìŠ¤ì¼€ì´í”„í•˜ì—¬ JSON ìœ íš¨ì„± í™•ë³´
          ESCAPED_REVIEW=$(echo "${{ steps.ai_review.outputs.review_body }}" | jq -Rs .)

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Pull Requestìš© Discord ë©”ì‹œì§€ ìƒì„±
            JSON_PAYLOAD=$(cat <<EOF
          {
            "username": "AI Reviewer ğŸ¤–",
            "embeds": [{
              "title": "AI Code Review on PR #${{ github.event.pull_request.number }}",
              "url": "${{ github.event.pull_request.html_url }}",
              "description": ${ESCAPED_REVIEW},
              "color": 5814783,
              "fields": [
                { "name": "ğŸ”€ Branch", "value": "${{ github.head_ref }} â†’ ${{ github.base_ref }}", "inline": true },
                { "name": "ğŸ§  Author", "value": "${{ github.event.pull_request.user.login }}", "inline": true }
              ],
              "footer": { "text": "Generated by GPT-4 via GitHub Actions" },
              "timestamp": "$(date --iso-8601=seconds)"
            }]
          }
          EOF
          )
          else
            # Pushìš© Discord ë©”ì‹œì§€ ìƒì„±
            JSON_PAYLOAD=$(cat <<EOF
          {
            "username": "AI Reviewer ğŸ¤–",
            "embeds": [{
              "title": "AI Code Review on push to ${{ github.ref_name }}",
              "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}",
              "description": ${ESCAPED_REVIEW},
              "color": 5814783,
              "fields": [
                { "name": "ğŸ”€ Branch", "value": "${{ github.ref_name }}", "inline": true },
                { "name": "ğŸ§  Author", "value": "${{ github.event.pusher.name }}", "inline": true }
              ],
              "footer": { "text": "Generated by GPT-4 via GitHub Actions" },
              "timestamp": "$(date --iso-8601=seconds)"
            }]
          }
          EOF
          )
          fi

          # Discord ì›¹í›…ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          curl -H "Content-Type: application/json" -X POST -d "$JSON_PAYLOAD" $DISCORD_WEBHOOK
    
